<!doctype html>
<html>
<head>
    <title>Example Domain</title>

    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
    body {
        background-color: #f0f0f2;
        margin: 0;
        padding: 0;
        font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
        
    }
    div {
        width: 600px;
        margin: 5em auto;
        padding: 50px;
        background-color: #fff;
        border-radius: 1em;
    }
    a:link, a:visited {
        color: #38488f;
        text-decoration: none;
    }
    @media (max-width: 700px) {
        body {
            background-color: #fff;
        }
        div {
            width: auto;
            margin: 0 auto;
            border-radius: 0;
            padding: 1em;
        }
    }
    </style>    
</head>

<body>
<div>
    <p>
Lorem ipsum dolor sit amet, consectetur adipiscing elit. In lobortis nibh tempor dolor convallis molestie. Phasellus accumsan, erat in porta sodales, nulla leo ultricies eros, vel ultricies est tortor id velit. Phasellus pulvinar sollicitudin purus id mollis. Aliquam hendrerit tortor id mattis condimentum. Nullam non arcu in dolor tempus faucibus. Donec nec sem tellus. Vestibulum tellus libero, rutrum sit amet dolor nec, consequat ultricies nulla. Pellentesque tristique augue eget erat pharetra eleifend. Praesent eu dolor ut metus ultrices sollicitudin sed eu eros. Duis aliquet sit amet nunc ut tempor. Praesent nisi leo, commodo et scelerisque ac, adipiscing eu elit. Donec posuere tortor iaculis sollicitudin sodales.
</p>
<p>
Curabitur mattis fringilla sem, at pellentesque tellus viverra a. Cras vitae mauris mi. Cras id nisi hendrerit, porttitor nibh sit amet, convallis nisi. Cras ultrices erat nunc, vitae dignissim sapien laoreet et. Duis placerat cursus diam, eget aliquam dolor scelerisque id. Sed eu ipsum purus. Praesent imperdiet, orci eget pretium sodales, tellus diam imperdiet sapien, eget fringilla dolor mi id orci. Nunc eu eros dui. Cras mattis lectus eget libero euismod, sit amet egestas leo iaculis. Nunc eu mattis sem. Sed in diam metus. Sed aliquam, diam dignissim lacinia tincidunt, sapien urna rutrum risus, nec aliquam diam est mollis urna.
</p>
<p>
Fusce lectus libero, tincidunt sit amet lacus in, ultricies dignissim justo. Pellentesque egestas orci non justo volutpat, sit amet aliquet nibh consequat. Nulla quis malesuada risus. Donec viverra purus in dictum pulvinar. Donec et lectus sed diam suscipit suscipit in a turpis. Vivamus ullamcorper hendrerit sapien et cursus. Sed vitae erat tristique, porta purus eu, venenatis sem. Pellentesque vel leo tempus odio bibendum pretium non sit amet purus. Sed sed ligula non nisi accumsan auctor facilisis convallis massa.
</p>
<p>
Nulla bibendum libero et ipsum mattis rhoncus. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Duis eget purus egestas, laoreet purus aliquam, pharetra nunc. Sed blandit pellentesque imperdiet. Aenean aliquam fringilla turpis, vel eleifend odio. Nunc vulputate pharetra sapien, id malesuada nibh bibendum eu. Vestibulum mauris massa, faucibus ac adipiscing quis, dignissim ac sapien. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Suspendisse non bibendum nisl, et pellentesque dui. Sed blandit pharetra nisi vitae cursus. Integer in eleifend sem, at accumsan augue. Donec placerat neque quis neque luctus, quis faucibus elit rutrum. Donec eleifend rhoncus massa quis euismod. Mauris eget justo consectetur, elementum nunc sit amet, aliquet mauris. Phasellus fermentum, tortor vel viverra vulputate, justo urna volutpat risus, accumsan imperdiet leo justo et metus. Nullam eleifend risus eget turpis iaculis, sed tristique urna accumsan.
</p>
<p>
Nulla auctor nibh enim, ac bibendum elit facilisis quis. Phasellus vel molestie ipsum. Fusce ligula est, dapibus sed purus quis, accumsan dictum eros. Duis a facilisis massa, id tempus orci. Phasellus massa leo, iaculis sed leo vel, dictum pulvinar metus. Sed congue blandit leo, sit amet lacinia augue eleifend id. Donec dapibus scelerisque augue, ut vehicula risus volutpat tempor. Etiam ligula arcu, sollicitudin suscipit dignissim vel, tincidunt et ipsum. Pellentesque tellus lacus, feugiat sed elit sed, consectetur mattis leo. Etiam auctor vehicula urna ac rhoncus. Maecenas varius congue nulla, sit amet egestas justo mollis nec. Morbi eget nisi viverra, faucibus elit sit amet, congue arcu. Aliquam ultricies leo ut erat tempor tincidunt. Sed ornare congue velit sit amet hendrerit. Vestibulum rhoncus arcu sit amet dui mollis, accumsan faucibus purus cursus. Duis adipiscing sollicitudin nisl quis malesuada.
</p>
<p>
Integer vestibulum libero eu varius venenatis. Morbi eleifend malesuada dictum. Cras sodales mattis molestie. Nam interdum ipsum sit amet tincidunt lacinia. Donec feugiat magna vel lacus tristique, eu tempus turpis luctus. Duis accumsan, mauris eu ultrices malesuada, lorem mi aliquet nisi, et suscipit odio lorem ac ante. Proin hendrerit dui ac arcu mollis porta. Quisque vitae velit et tellus luctus pellentesque. Morbi orci eros, vehicula ac ultricies facilisis, pretium nec turpis. Vestibulum eu metus quis arcu consectetur interdum vitae in metus. Quisque in venenatis nisl, quis dictum ipsum. Vestibulum feugiat convallis nulla, non blandit enim tincidunt at.
</p>
<p>
Nullam tristique libero eu purus pulvinar, sed porta risus egestas. Proin auctor neque et ligula tempus vehicula. Vestibulum tempus facilisis sem, a laoreet odio porttitor sed. Ut augue lectus, dignissim quis tincidunt et, porta eu urna. Suspendisse fermentum mi tincidunt diam vulputate, sit amet tincidunt lectus porttitor. Maecenas sit amet eros laoreet, adipiscing libero vel, adipiscing felis. Pellentesque vitae nulla viverra, semper enim id, mollis ipsum. Sed ultricies dolor eget quam adipiscing bibendum. Fusce porta consectetur scelerisque. Donec eget metus a lorem consectetur vestibulum. Sed laoreet vulputate mauris quis elementum.
</p>
<p>
Nullam luctus augue nec metus pharetra tempus. Cras ac nulla neque. Integer non aliquam urna. In vel arcu commodo, tempor nisl ut, dapibus nulla. Phasellus nec volutpat metus. Mauris non sollicitudin tellus. Morbi facilisis magna quis nulla condimentum volutpat. Pellentesque fermentum id ligula sit amet interdum. Aenean vitae lacinia nibh. Curabitur malesuada scelerisque tortor rhoncus rutrum. Vestibulum velit nisi, consequat et pulvinar id, vestibulum vel massa. Pellentesque porttitor laoreet ligula, eget fringilla orci dictum et. Aenean vitae imperdiet magna, in lobortis lectus.
</p>
<p>
Nunc vulputate ante vel tempus vulputate. Phasellus eu orci vehicula, porttitor felis id, semper erat. Nulla sed vehicula ante, in interdum odio. Aenean imperdiet in eros a elementum. Vestibulum ultrices ipsum nisi, ac sagittis orci rutrum eget. Sed vitae tellus id elit auctor tincidunt non dignissim justo. Nullam non mauris hendrerit, egestas nisi vel, rutrum tellus. Nullam mi odio, porta sit amet bibendum ultrices, imperdiet at urna. Sed iaculis condimentum vulputate. Ut sagittis, urna at dapibus iaculis, felis ante mattis mauris, non ultricies nulla velit ut nunc.
</p>
<p>
Proin iaculis odio elit, sit amet egestas tortor tempus vitae. Praesent porta arcu in est condimentum, faucibus eleifend odio tincidunt. Quisque ut enim nec augue posuere adipiscing. Morbi laoreet leo in tincidunt pretium. Phasellus vitae metus eget nisi facilisis accumsan a non dui. Maecenas pharetra interdum tortor, vel condimentum nulla pharetra sed. Integer pellentesque euismod velit ac varius. Donec mauris leo, eleifend vel tempus eu, pulvinar id justo.
</p></div>
</div>
    <script src="lib/all.js"></script>
    <script src="explosion.js"></script>
    <script>
        var StartTime = new Date().getTime() /1000;
        createCanvasOverlay(1);
        createCanvasOverlay(2);
        var fabricCanvas = new fabric.StaticCanvas('c1');
        var textArray = new Array();
        addCharsToCanvas(fabricCanvas);
        initializeImage();
        console.log(fabricCanvas.height);

        var FinishTime = new Date().getTime() / 1000;
        console.log("total Time: " + (FinishTime - StartTime));

        function initializeImage() {
            var StartTime = new Date().getTime() /1000;
            var raw_img = new Image();
            raw_img.crossOrigin = 'anonymous';
            raw_img.src = 'https://dl.dropboxusercontent.com/u/6258038/test.jpg';
            raw_img.onload = function() {
                var canvas = document.getElementById('c2')
                var ctx = canvas.getContext('2d');
                ctx.drawImage(raw_img, 0, 0);
                var scaleFactor = ex.sum / calculateSize(this.width, this.height);
                alert("Started");
                pixels = scaleDisShit(raw_img, scaleFactor, this.width, this.height);
                alert('Finished');
            };
            var FinishTime = new Date().getTime() / 1000;
            console.log("initializeImage time: " + (FinishTime - StartTime));
        }

        function addCharsToCanvas(canvas){
            var StartTime = new Date().getTime() /1000;
            ex = new Explosion()
            var sum = 0;
            console.log(ex.chars.length);
            for(var i = 0; i < ex.chars.length; i++) {
                var c = ex.chars[i];
                var x = c.offsetLeft;
                var y = c.offsetTop;
                var text = new fabric.Text(c.char, {
                    left:x, 
                    top:y,
                    fontSize: c.fontsize,
                    fontFamily: c.fontfamily,
                    textDecoration: c.textdecoration,
                    fontStyle: c.fontstyle,
                    textAlign: c.textalign,
                    stroke: c.stroke,
                    strokeweight: c.strokeweight
                });
                sum += c.width*c.height;
                textArray[i] = text;
            }
            var group = new fabric.Group(textArray, {
            });
            canvas.add(group);
            ex.sum = sum;
            var FinishTime = new Date().getTime() / 1000;
            console.log("addCharsToCanvas time: " + (FinishTime - StartTime));
        }

        function scaleDisShit(raw_img, scaleFactor, width, height) {
            var StartTime = new Date().getTime() / 1000;
            var canvas = document.getElementById('c2')
            var ctx = canvas.getContext('2d');
            var newWidth = Math.round(width*scaleFactor);
            var newHeight = Math.round(height*scaleFactor);
            if (newWidth - canvas.width > 0 || newHeight - canvas.height > 0)
            {
                ctx.drawImage(raw_img, 0, 0, canvas.width, canvas.height);
            }
            else
            {
                ctx.drawImage(raw_img, 0, 0, newWidth*scaleFactor, newHeight*scaleFactor);
            }
            var px = findFilledPixels(newWidth, newHeight);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            var FinishTime = new Date().getTime() / 1000;
            console.log("scaleDisShit time: " + (FinishTime - StartTime));
            return px;
        }


         function createCanvasOverlay(number)
         {
            var canvasContainer = document.createElement('div');
            document.body.appendChild(canvasContainer);
            canvasContainer.style.position="absolute";
            canvasContainer.style.left="0px";
            canvasContainer.style.top="0px";
            canvasContainer.style.width="100%";
            canvasContainer.style.height="100%";
            canvasContainer.style.zIndex="100" + number;
            canvasContainer.id = 'c' + number + '_container';

            myCanvas = document.createElement('canvas');
            myCanvas.style.width = canvasContainer.scrollWidth+"px";
            myCanvas.style.height = canvasContainer.scrollHeight+"px";
            myCanvas.width=canvasContainer.scrollWidth;
            myCanvas.height=canvasContainer.scrollHeight;
            myCanvas.style.overflow = 'visible';
            myCanvas.style.position = 'absolute';
            myCanvas.style.left="0px";
            myCanvas.style.top="0px";
            myCanvas.id = 'c' + number;
            myCanvas.style.zIndex = "100" + (3-number);
            document.body.removeChild(canvasContainer);
            document.body.appendChild(myCanvas);
         }

        function findFilledPixels(width, height) {
            var StartTime = new Date().getTime() / 1000;
            var pxl_map = new Array();
            var canvas = document.getElementById("c2")
            var outMax = width;
            var inMax = height;
            var count = 0;
            var num = 0;
            var yStart = 0;
            var ctx = canvas.getContext('2d');
            var data = ctx.getImageData(0, 0, width, height).data;
            for (var x = 0; x < outMax; x++) 
            {
                var inCount = 0;
                tmp = new Array();
                pxl_map[x] = tmp;
                for (var y = 0; y < inMax; y++) 
                {
                    var currRed = parseInt(data[num]);
                    var currGreen = parseInt(data[num+1]);
                    var currBlue = parseInt(data[num+2]);
                    var isFilled = currRed + currBlue + currGreen < (3*200);
                    if(isFilled) {
                        pxl_map[x][y] = true;
                    }
                    else {

                        pxl_map[x][y] = false;
                    }
                    num += 4; 
                }
            }

            var FinishTime = new Date().getTime() / 1000;
            console.log("findFilledPixels time: " + (FinishTime - StartTime));

            return pxl_map;
        }

        function calculateSize(width, height) {
            var StartTime = new Date().getTime() / 1000;
            var pxl_map = new Array();
            var outMax = width;
            var inMax = height;
            var count = 0;
            var num = 0;
            var yStart = 0;
            var canvas = document.getElementById('c2')
            var ctx = canvas.getContext('2d');
            var data = ctx.getImageData(0, 0, outMax, inMax).data;
            for (var x = 0; x < outMax; x++) //= x + 3)
            {
                var inCount = 0;
                for (var y = yStart; y < inMax; y++) //= y + 5)
                {
                    tmp = new Array();
                    var currRed = parseInt(data[num]);
                    var currGreen = parseInt(data[num+1]);
                    var currBlue = parseInt(data[num+2]);
                    var isFilled = currRed + currBlue + currGreen < (3*200)
                    if(isFilled)
                        count += 1;
                    num += 4; 
                }
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            var FinishTime = new Date().getTime() / 1000;

            console.log("calculate size time: " + (FinishTime - StartTime));
            return count;
        }
    </script>
</body>
</html>
